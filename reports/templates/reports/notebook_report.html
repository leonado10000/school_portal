{% extends 'common/index.html' %}

{% block content %}
<style>
  :root{
    --bg: #0f1620;
    --card: #141821;
    --muted: #98a0a6;
    --accent: #4facfe;
    --good: #2dc58a;
    --bad: #ff6b6b;
  }

  .wrap { padding: 14px; max-width: 820px; margin: 0 auto; color: #e6eef8; }
  .card-dark { background: var(--card); border-radius: 12px; padding: 12px; box-shadow: 0 6px 18px rgba(2,6,12,0.6); }
  .muted { color: var(--muted); font-size: .95rem; }
  h3.page-title { font-size: 1.05rem; margin-bottom: 8px; font-weight: 600; }
  .stat-big { font-size: 1.8rem; font-weight: 700; color: #fff; }
  .row-gap { gap: 10px; }
  .small-note { font-size: .85rem; color: var(--muted); }
  .progress { height: 10px; border-radius: 8px; background: rgba(255,255,255,0.04); }
  .progress .progress-bar { box-shadow: none; }
  .list-item { padding: 10px 8px; border-radius: 10px; background: rgba(255,255,255,0.02); margin-bottom: 8px; }
  @media (min-width: 768px) {
    .wrap { padding: 20px; }
  }
</style>

<div class="wrap">

  <!-- HEADER + FILTERS -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="page-title">ðŸ“‹ Notebook Checking Report</h3>
    <a href="{% url 'class_list' %}" class="btn btn-sm btn-outline-light">Students</a>
  </div>

  <form method="get" class="card-dark mb-3">
    <div class="d-flex row-gap flex-column">
      <div class="d-flex">
        <input type="date" name="start_date" class="form-control me-2" value="{{ filter_start }}" placeholder="From">
        <input type="date" name="end_date" class="form-control" value="{{ filter_end }}" placeholder="To">
      </div>

      <div class="d-flex mt-2">
        <select name="batch" class="form-select me-2">
          <option value="">All classes</option>
          {% for b in batches %}
            <option value="{{ b.id }}" {% if filter_batch and filter_batch == b.id %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
        </select>

        <input type="number" name="top_n" class="form-control" min="1" max="100"
               title="Top N" value="{{ top_n }}" style="max-width: 92px;">
      </div>

      <div class="d-flex mt-2">
        <button type="submit" class="btn btn-primary w-100">Apply</button>
      </div>
    </div>
  </form>

  <!-- TOTAL -->
  <div class="card-dark mb-3 d-flex justify-content-between align-items-center">
    <div>
      <div class="small-note">Total Notebook Checking</div>
      <div class="stat-big">{{ total_records }}</div>
      <div class="muted">Showing results for selected filters (or all-time)</div>
    </div>
  </div>

  <!-- CLASS-WISE -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>Class-wise breakdown</strong>
      <small class="muted">Total / Completed (%)</small>
    </div>

    {% for c in class_stats %}
      <div class="card-dark list-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">{{ c.label }}</div>
            <div class="muted small-note">Class: {{ c.current_class }}</div>
          </div>
          <div class="text-end">
            <div class="fw-bold">{{ c.total }}</div>
            <div class="muted small-note">{{ c.checked }} done</div>
          </div>
        </div>

        <div class="mt-2">
          <div class="d-flex justify-content-between small-note mb-1">
            <div>Completion</div>
            <div>{{ c.rate_percent }}%</div>
          </div>
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: {{ c.rate_percent }}%; background: linear-gradient(90deg, var(--accent), #43e97b);"
                 aria-valuenow="{{ c.rate_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- BEST TEN -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>Top {{ best_ten|length }} â€” Best performers</strong>
      <small class="muted">By checked rate</small>
    </div>

    {% if best_ten %}
      {% for s in best_ten %}
        <a href="{% url 'student_detail' s.student_id %}" class="d-block card-dark list-item text-decoration-none text-light">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ s.name }}</div>
              <div class="muted small-note">Roll {{ s.roll }} â€¢ {{ s.student_key }}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold">{{ s.checked }}/{{ s.total }}</div>
              <div class="muted small-note">{{ s.rate_percent }}%</div>
            </div>
          </div>
          <div class="mt-2">
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: {{ s.rate_percent }}%; background: linear-gradient(90deg, #2dc58a, #62d3a0);"
                   aria-valuenow="{{ s.rate_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </a>
      {% endfor %}
    {% else %}
      <div class="card-dark list-item text-center muted">No data for selected filters</div>
    {% endif %}
  </div>

  <!-- WORST TEN -->
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>Bottom {{ worst_ten|length }} â€” Needs attention</strong>
      <small class="muted">Low checked rate</small>
    </div>

    {% if worst_ten %}
      {% for s in worst_ten %}
        <a href="{% url 'student_detail' s.student_id %}" class="d-block card-dark list-item text-decoration-none text-light">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ s.name }}</div>
              <div class="muted small-note">Roll {{ s.roll }} â€¢ {{ s.student_key }}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold">{{ s.checked }}/{{ s.total }}</div>
              <div class="muted small-note">{{ s.rate_percent }}%</div>
            </div>
          </div>
          <div class="mt-2">
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: {{ s.rate_percent }}%; background: linear-gradient(90deg, #ff8a6b, #ff6b6b);"
                   aria-valuenow="{{ s.rate_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </a>
      {% endfor %}
    {% else %}
      <div class="card-dark list-item text-center muted">No data for selected filters</div>
    {% endif %}
  </div>

</div>
{% endblock %}
