{% extends 'common/index.html' %}
{% block content %}

<style>
    table {
        border-collapse: collapse;
        width: 100%;
        margin: 20px 0;
    }

    th, td {
        border: 2px solid #ced4da;
        text-align: center;
        padding: 10px;
        font-weight: 500;
        font-size: 14px;
        color: #495057;
    }

    thead th {
        font-weight: 600;
        font-size: 13px;
        color: #343a40;
    }

    /* Consistent Color Patterns */
    th.subject-name {
        background-color: #e3f2fd;
    }

    td.subject-name {
        background-color: #e3f2fd;
    }

    th.theory {
        background-color: #fff3cd;
    }

    td.theory {
        background-color: #fff3cd;
    }

    th.assessment {
        background-color: #d4edda;
    }

    td.assessment {
        background-color: #d4edda;
    }

    th.subtotal {
        background-color: #f8d7da;
    }

    td.subtotal {
        background-color: #f8d7da;
    }

    th.total, td.total {
        background-color: #d6d8db;
        font-weight: 600;
    }

    th.info, td.info {
        background-color: #f8f9fa;
    }

    input[type="number"] {
        width: 60px;
        padding: 5px;
        text-align: center;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
        background-color: #ffffff;
    }

    @media (max-width: 768px) {
        table, thead, tbody, th, td, tr {
            display: block;
        }

        thead tr {
            display: none;
        }

        tbody tr {
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            background-color: #ffffff;
        }

        td {
            border: none;
            padding: 8px 10px;
            font-size: 13px;
            text-align: left;
            position: relative;
        }

        td::before {
            content: attr(data-label);
            font-weight: 600;
            color: #495057;
            position: absolute;
            left: 10px;
            top: 8px;
        }

        td.info, td.total, td.subject-name, td.theory, td.assessment, td.subtotal {
            background-color: transparent !important;
        }

        input[type="number"] {
            width: 100%;
        }
    }

    .submit-btn {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
    }
</style>

<form action="" method="post">
    {% csrf_token %}

    <table>
        <thead>
            <tr>
                <th rowspan="2" class="info">Roll No.</th>
                <th rowspan="2" class="info">Name</th>
                <th rowspan="2" class="info">Father</th>
                {% for subject in subjects %}
                    <th colspan="3" class="subject-name">{{ subject }}</th>
                {% endfor %}
                <th rowspan="2" class="total">Marks Obtained</th>
                <th rowspan="2" class="total">Percentage</th>
            </tr>
            <tr>
                {% for subject in subjects %}
                    <th class="theory">THY. <br>(80)</th>
                    <th class="assessment">ASS. <br>(20)</th>
                    <th class="subtotal">TOTAL (100)</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr data-student-id="{{ student.id }}">
                <td class="info" data-label="Roll No.">{{ student.roll_no }}</td>
                <td class="info" data-label="Name">{{ student.name }}</td>
                <td class="info" data-label="Father">{{ student.father }}</td>
                {% for subject in subjects %}
                    <td class="theory" data-label="Theory">
                        <input type="number" name="marks-{{ student.id }}-{{ subject }}-theory" class="theory-input" data-student="{{ student.id }}" data-subject="{{ subject }}" value="0" min="0" max="80">
                    </td>
                    <td class="assessment" data-label="Assessment">
                        <input type="number" name="marks-{{ student.id }}-{{ subject }}-assessment" class="assessment-input" data-student="{{ student.id }}" data-subject="{{ subject }}" value="0" min="0" max="20">
                    </td>
                    <td class="subtotal" data-label="Subtotal">
                        <input type="number" name="marks-{{ student.id }}-{{ subject }}-subtotal" class="subtotal-input" data-student="{{ student.id }}" data-subject="{{ subject }}" value="0" readonly>
                    </td>
                {% endfor %}
                <td class="total" data-label="Marks Obtained">
                    <input type="number" name="marks-{{ student.id }}-obtained" class="total-obtained-input" data-student="{{ student.id }}" value="0" readonly>
                </td>
                <td class="total" data-label="Percentage">
                    <input type="number" name="marks-{{ student.id }}-percentage" class="percentage-input" data-student="{{ student.id }}" value="0" readonly>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="submit" class="submit-btn">Submit Marks</button>
</form>

<script>
    document.addEventListener('input', function(event) {
        if (event.target.classList.contains('theory-input') || event.target.classList.contains('assessment-input')) {
            const studentId = event.target.dataset.student;
            const subject = event.target.dataset.subject;

            const theoryInput = document.querySelector(`input[name="marks-${studentId}-${subject}-theory"]`);
            const assessmentInput = document.querySelector(`input[name="marks-${studentId}-${subject}-assessment"]`);
            const subtotalInput = document.querySelector(`input[name="marks-${studentId}-${subject}-subtotal"]`);

            const theoryMarks = parseInt(theoryInput.value) || 0;
            const assessmentMarks = parseInt(assessmentInput.value) || 0;

            // Update Subtotal
            const subtotal = theoryMarks + assessmentMarks;
            subtotalInput.value = subtotal;

            // Update Total Obtained and Percentage
            updateTotalAndPercentage(studentId);
        }
    });

    function updateTotalAndPercentage(studentId) {
        const subtotalInputs = document.querySelectorAll(`input.subtotal-input[data-student="${studentId}"]`);
        const totalObtainedInput = document.querySelector(`input.total-obtained-input[data-student="${studentId}"]`);
        const percentageInput = document.querySelector(`input.percentage-input[data-student="${studentId}"]`);

        let totalObtained = 0;
        subtotalInputs.forEach(input => {
            totalObtained += parseInt(input.value) || 0;
        });

        const totalSubjects = subtotalInputs.length;
        const totalPossibleMarks = totalSubjects * 100;

        totalObtainedInput.value = totalObtained;
        percentageInput.value = totalSubjects > 0 ? ((totalObtained / totalPossibleMarks) * 100).toFixed(2) : 0;
    }
</script>

{% endblock %}
